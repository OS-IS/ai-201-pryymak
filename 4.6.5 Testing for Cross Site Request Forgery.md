---

### Тестування на фіксацію сесії

---

### Резюме  

Фіксація сесії відбувається через небезпечну практику збереження того ж значення сесійних cookie-файлів до і після аутентифікації. Це зазвичай трапляється, коли cookie-файли використовуються для збереження інформації про стан навіть до входу, наприклад, для додавання товарів у кошик перед аутентифікацією для оплати.  

У типовій експлуатації вразливостей фіксації сесії зловмисник може отримати набір сесійних cookie-файлів із цільового сайту без попередньої аутентифікації. Потім зловмисник може примусово вставити ці cookie-файли в браузер жертви за допомогою різних технік. Якщо жертва пізніше аутентифікується на цільовому сайті, і cookie-файли не оновлюються при вході, жертва буде ідентифікована за допомогою сесійних cookie-файлів, вибраних зловмисником. Таким чином, зловмисник може видавати себе за жертву, використовуючи ці відомі cookie-файли.  

Цю проблему можна вирішити шляхом оновлення сесійних cookie-файлів після процесу аутентифікації. Альтернативно, атаку можна запобігти, забезпечивши цілісність сесійних cookie-файлів. Для захисту від мережевих атак (наприклад, коли зловмисник контролює мережу, яку використовує жертва) слід використовувати повний HSTS або додати префікси `__Host-` / `__Secure-` до імен cookie-файлів.  

Повне впровадження HSTS передбачає активацію HSTS для хоста та всіх його піддоменів. Це описано в статті *Testing for Integrity Flaws in Web Sessions* (автори: Стефано Кальзавара, Альвізе Рабітті, Алессіо Рагаццо та Мікеле Буглієзі).  

---

### Цілі тестування  

- Аналізувати механізм аутентифікації та його потік.  
- Примусово вставити cookie-файли та оцінити їх вплив.  

---

### Як проводити тестування  

#### Загальний опис стратегії  

1. Зробіть запит на сайт, який тестується (наприклад, `www.example.com`).  
2. Якщо тестувальник виконає запит:  
   ```
   GET / HTTP/1.1  
   Host: www.example.com  
   ```
   Відповідь сервера буде наступною:  
   ```
   HTTP/1.1 200 OK  
   Date: Wed, 14 Aug 2008 08:45:11 GMT  
   Server: IBM_HTTP_Server  
   Set-Cookie: JSESSIONID=0000d8eyYq3L0z2fgq10m4v-rt4:-1; Path=/; secure  
   Cache-Control: no-cache="set-cookie,set-cookie2"  
   Expires: Thu, 01 Dec 1994 16:00:00 GMT  
   Keep-Alive: timeout=5, max=100  
   Connection: Keep-Alive  
   Content-Type: text/html;charset=Cp1254  
   Content-Language: en-US  
   ```
   Додаток створює новий ідентифікатор сесії: `JSESSIONID=0000d8eyYq3L0z2fgq10m4v-rt4:-1` для клієнта.  

3. Якщо тестувальник успішно аутентифікується через наступний POST-запит до `https://www.example.com/authentication.php`:  
   ```
   POST /authentication.php HTTP/1.1  
   Host: www.example.com  
   [...]  
   Referer: http://www.example.com  
   Cookie: JSESSIONID=0000d8eyYq3L0z2fgq10m4v-rt4:-1  
   Content-Type: application/x-www-form-urlencoded  
   Content-length: 57  

   Name=Meucci&wpPassword=secret!&wpLoginattempt=Log+in  
   ```

   Тестувальник отримає наступну відповідь від сервера:  
   ```
   HTTP/1.1 200 OK  
   Date: Thu, 14 Aug 2008 14:52:58 GMT  
   Server: Apache/2.2.2 (Fedora)  
   X-Powered-By: PHP/5.1.6  
   Content-language: en  
   Cache-Control: private, must-revalidate, max-age=0  
   X-Content-Encoding: gzip  
   Content-length: 4090  
   Connection: close  
   Content-Type: text/html; charset=UTF-8  
   ...  
   HTML data  
   ...
   ```

   Якщо після успішної аутентифікації новий cookie-файл не видано, це означає, що можливе викрадення сесії, якщо не забезпечена цілісність сесійного cookie.  

---

#### Тестування з примусовими cookie-файлами  

Ця стратегія орієнтована на мережевих атакувальників і застосовується лише до сайтів без повного впровадження HSTS.  

**Кроки для тестування:**  
1. Перейдіть на сторінку входу сайту.  
2. Збережіть знімок cookie-файлів до входу, виключивши cookie-файли з префіксами `__Host-` або `__Secure-`.  
3. Ввійдіть на сайт як жертва та перейдіть на сторінку із захищеною функцією, яка вимагає аутентифікації.  
4. Відновіть cookie-файли із знімка, зробленого на кроці 2.  
5. Використайте захищену функцію, визначену на кроці 3.  
6. Перевірте, чи була операція успішною. Якщо так, атака вдалася.  

**Рекомендації:**  
- Використовуйте два різні комп’ютери або браузери для жертви та атакувальника, щоб зменшити кількість хибнопозитивних результатів.  

---

### Усунення  

- Реалізуйте оновлення токенів сесії після успішної аутентифікації.  
- Завжди анулюйте існуючий ідентифікатор сесії перед аутентифікацією, а після успішного входу надавайте новий ідентифікатор сесії.  

---

### Інструменти  

- **ZAP**

---

### Довідкові матеріали  

- [Session Fixation](https://en.wikipedia.org/wiki/Session_fixation)  
- **ACROS Security**  
- **Chris Shiflett**

---
