---

### Тестування на фіксацію сесії

---

**Резюме**  
Сесійна фіксація можлива через небезпечну практику збереження однакового значення сесійних куків до і після аутентифікації. Це зазвичай трапляється, коли сесійні куки використовуються для збереження інформації про стан навіть до входу в систему, наприклад, для додавання товарів у кошик до аутентифікації для оплати.

У типовій експлуатації вразливостей сесійної фіксації зловмисник може отримати набір сесійних куків із цільового сайту без попередньої аутентифікації. Потім зловмисник може використати різні методи для примусового встановлення цих куків у браузері жертви. Якщо жертва пізніше увійде на цільовий сайт і куки не буде оновлено після входу, жертву ідентифікуватимуть за сесійними куками, обраними зловмисником. Тоді зловмисник може видавати себе за жертву, використовуючи ці відомі куки.

Цю проблему можна вирішити, оновивши сесійні куки після завершення процесу аутентифікації. Альтернативно, атаку можна запобігти, забезпечивши цілісність сесійних куків. Для захисту від мережевих атак (коли зловмисник контролює мережу жертви) слід використовувати повний HSTS або додати префікси **__Host-** / **__Secure-** до імені куків.

Повна підтримка HSTS реалізується, коли хост активує HSTS для себе і всіх своїх піддоменів. Це описано у дослідженні **Testing for Integrity Flaws in Web Sessions** авторства Стефано Кальзавари, Альвізе Рабітті, Алессіо Рагаццо та Мікеле Бульєзі.

---

### **Цілі тестування**  
- Аналізувати механізм аутентифікації та його потік.  
- Примусово встановлювати куки та оцінювати вплив.

---

### **Як тестувати**  
У цьому розділі подано пояснення стратегії тестування, яка буде продемонстрована далі.

#### Крок 1  
Відправити запит на тестований сайт (наприклад, www.example.com).  
Якщо тестувальник відправляє такий запит:  
```
GET / HTTP/1.1  
Host: www.example.com
```

Він отримає таку відповідь:  
```
HTTP/1.1 200 OK  
Date: Wed, 14 Aug 2008 08:45:11 GMT  
Server: IBM_HTTP_Server  
Set-Cookie: JSESSIONID=0000d8eyYq3L0z2fgq10m4v-rt4:-1; Path=/; secure  
Cache-Control: no-cache="set-cookie,set-cookie2"  
Expires: Thu, 01 Dec 1994 16:00:00 GMT  
Keep-Alive: timeout=5, max=100  
Connection: Keep-Alive  
Content-Type: text/html;charset=Cp1254  
Content-Language: en-US
```

Додаток встановлює новий ідентифікатор сесії:  
`JSESSIONID=0000d8eyYq3L0z2fgq10m4v-rt4:-1` для клієнта.

#### Крок 2  
Успішно аутентифікуватися до додатку за допомогою такого запиту POST до `https://www.example.com/authentication.php`:  
```
POST /authentication.php HTTP/1.1  
Host: www.example.com  
[...]  
Referer: http://www.example.com  
Cookie: JSESSIONID=0000d8eyYq3L0z2fgq10m4v-rt4:-1  
Content-Type: application/x-www-form-urlencoded  
Content-length: 57  

Name=Meucci&wpPassword=secret!&wpLoginattempt=Log+in
```

Сервер відповідає так:  
```
HTTP/1.1 200 OK  
Date: Thu, 14 Aug 2008 14:52:58 GMT  
Server: Apache/2.2.2 (Fedora)  
X-Powered-By: PHP/5.1.6  
Content-language: en  
Cache-Control: private, must-revalidate, max-age=0  
X-Content-Encoding: gzip  
Content-length: 4090  
Connection: close  
Content-Type: text/html; charset=UTF-8
...
HTML data
...
```

Якщо новий сесійний куки не видано після успішної аутентифікації, тестувальник знає, що можлива крадіжка сесії, якщо цілісність сесійного кука не забезпечена.

---

### **Тестування з примусовими куками**  
Ця стратегія тестування спрямована на мережевих зловмисників і застосовується до сайтів без повної підтримки HSTS (сайти з повною підтримкою HSTS є безпечними, оскільки всі їхні куки мають цілісність). 

#### Кроки тестування:  
1. Перейдіть на сторінку входу сайту.  
2. Збережіть знімок поточного набору куків (cookie jar) перед входом, виключаючи куки з префіксами **__Host-** або **__Secure-** у їхніх іменах.  
3. Увійдіть на сайт як жертва та перейдіть на будь-яку сторінку, яка пропонує захищену функцію, що вимагає аутентифікації.  
4. Відновіть набір куків із знімка, збереженого на кроці 2.  
5. Викличте захищену функцію, вказану на кроці 3.  
6. Перевірте, чи виконано дію на кроці 5. Якщо так, атака вдалася.  
7. Очистіть куки, увійдіть як зловмисник і повторіть крок 3.  
8. По одному запишіть куки з кроку 2 до cookie jar.  
9. Викличте захищену функцію, як описано на кроці 3.  
10. Очистіть куки та знову увійдіть як жертва.  
11. Перевірте, чи було виконано дію з кроку 9 у контексті облікового запису жертви. Якщо так, атака вдалася; якщо ні — сайт захищений від фіксації сесій.

---

### **Усунення**  
- Реалізуйте оновлення токена сесії після успішної аутентифікації користувача.  
- Додаток завжди повинен спершу анулювати існуючий ідентифікатор сесії перед аутентифікацією користувача, а після успішної аутентифікації надати новий ідентифікатор сесії.

### Інструменти  

- **ZAP**

---

### Довідкові матеріали  

- [Session Fixation](https://en.wikipedia.org/wiki/Session_fixation)  
- **ACROS Security**  
- **Chris Shiflett**

---
